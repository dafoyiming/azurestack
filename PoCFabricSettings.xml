<!--
  <copyright file="PoCFabricSettings.xml" company="Microsoft">
    Copyright (C) Microsoft. All rights reserved.
  </copyright>
-->
<Settings>
  <Task>
    <Name>EnableRemotePS</Name>
    <Cmd>EnableRemotePS.ps1</Cmd>
    <Weight>27</Weight>
    <Timeout>150</Timeout>
    <Retry>1</Retry>
  </Task> <!-- EnableRemotePS -->
  <Task>
    <Name>InstallFeature</Name>
    <Cmd>InstallFeature.ps1</Cmd>
    <Retry>1</Retry>
    <Weight>90</Weight>
    <Timeout>540</Timeout>
    <Parameters>
      <Features>Hyper-V,RSAT-Hyper-V-Tools,Failover-Clustering,RSAT-Clustering-Mgmt,RSAT-Clustering-PowerShell,RSAT-Clustering-CmdInterface,FS-FileServer,RSAT-AD-Tools,Data-Center-Bridging</Features>
    </Parameters>
  </Task> <!-- InstallFeature -->
  <Task>
    <Name>SetupvSwitch</Name>
    <Cmd>SetupvSwitch.ps1</Cmd>
    <CleanupCmd>CleanupvSwitch.ps1</CleanupCmd>
    <Weight>44</Weight>
    <Timeout>2500</Timeout>
    <Retry>2</Retry>
    <Dependency>InstallFeature</Dependency>
    <Parameters>
      <Type>External</Type>  <!--External,Internal,Private-->
      <Name>CCI_External_vSwitch</Name>
      <PublicNicName></PublicNicName> <!--Empty for auto detect-->
      <VLAN>{[Global]:PublicVLan}</VLAN>
      <AdditionalHostNic>
        <Name>Private1001</Name>
        <IP>192.168.100.10/24</IP>        
        <VLAN>{[Global]:InternalNetworkVLan}</VLAN>
        <DNSList>
          <DNS>{[Global]:InternalDNS}</DNS>
        </DNSList>
        <DNSSuffix>{[Global]:ADDomainName}</DNSSuffix>
        <InterfaceMetric>50</InterfaceMetric>
      </AdditionalHostNic>      
    </Parameters>
  </Task> <!-- SetupvSwitch -->
  <Task> 
    <Name>HostConfigration</Name>
    <Cmd>HostConfigration.ps1</Cmd>
    <CleanupCmd>CleanupHostConfigration.ps1</CleanupCmd>
    <Dependency>SetupvSwitch</Dependency>
    <Weight>5</Weight>
    <Timeout>60</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <NicName>{[SetupvSwitch]:AdditionalHostNic.Name}</NicName>
    </Parameters>
  </Task> <!-- HostConfigration -->
  <Task> 
    <Name>EnableVFP</Name>
    <Cmd>EnableVFP.ps1</Cmd>
    <CleanupCmd>DisableVFP.ps1</CleanupCmd>
    <Weight>5</Weight>
    <Retry>1</Retry>
    <Timeout>60</Timeout>
    <Dependency>SetupvSwitch</Dependency>
    <Parameters>
      <VFPvSwitchName>{[SetupvSwitch]:Name}</VFPvSwitchName>
    </Parameters>
  </Task> <!-- EnableVFP -->
  <Task> 
    <Name>DisableUnusedNic</Name>
    <Cmd>DisableUnusedNic.ps1</Cmd>
    <Weight>9</Weight>
    <Retry>2</Retry>
    <Timeout>60</Timeout>
    <Dependency>SetupvSwitch</Dependency>
  </Task> <!-- DisableUnusedNic -->
  <Task>
    <Name>FindFreeDisk</Name>
    <Cmd>FindFreeDisk.ps1</Cmd>
    <Weight>27</Weight>
    <Timeout>150</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <Path></Path>
    </Parameters>
  </Task> <!-- FindFreeDisk -->
  <Task> 
    <Name>CopyVhdx_Local</Name>
    <Cmd>CopyFile.ps1</Cmd>
    <Dependency>FindFreeDisk</Dependency>
    <Weight>166</Weight>
    <Timeout>1265</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <File>
        <From>{[Global]:PackagePath}</From>
        <To>{[FindFreeDisk]:Path}</To>
        <FileName>{[Global]:VHDs.OSVHD}</FileName>
      </File>
    </Parameters>
  </Task> <!-- CopyVhdx_Local -->
  <Task> 
    <Name>ADVM</Name>
    <Cmd>CreateVM.ps1</Cmd>
    <CleanupCmd>DeleteVM.ps1</CleanupCmd>
    <Dependency>EnableRemotePS</Dependency>
    <Dependency>EnableVFP</Dependency>
    <Dependency>CopyVhdx_Local</Dependency>
    <Retry>5</Retry>
    <Weight>400</Weight>
    <Timeout>3400</Timeout>
    <Parameters>
      <Name>ADVM</Name>
      <VMPath>{[FindFreeDisk]:Path}</VMPath>
      <ProcessorCount>4</ProcessorCount>
      <RAM>3</RAM>   
      <MinRAM>2</MinRAM>   
      <MaxRAM>4</MaxRAM>   
      <Disk>
        <Base>{[FindFreeDisk]:Path}\{[Global]:VHDs.OSVHD}</Base>        
        <Features>
          <Name>AD-Domain-Services,DNS</Name>        
        </Features>
      </Disk>
      <Nics>
        <Nic>
          <Name>Nic1</Name>
          <vSwitch>{[SetupvSwitch]:Name}</vSwitch>
          <VLAN>{[Global]:InternalNetworkVLan}</VLAN>
          <DHCP>false</DHCP>
          <IP>192.168.100.2/24</IP>
          <GW>{[Global]:InternalGW}</GW>
          <DNSList>
            <DNS>{[Global]:InternalDNS}</DNS>
          </DNSList>
        </Nic>
      </Nics>
      <LocalAccounts>
        <AdministratorPassword>{[Global]:AdminPassword}</AdministratorPassword>
        <Account>
          <Name>AzureStackAdmin</Name>
          <Password>{[Global]:AdminPassword}</Password>
          <Group>Administrators</Group>
        </Account>
        <Account>
          <Name>AzureStackUser</Name>
          <Password>{[Global]:AdminPassword}</Password>
          <Group>Users</Group>
        </Account>
      </LocalAccounts>
    </Parameters>
  </Task> <!-- ADVM -->
  <Task> 
    <Name>DCPromo</Name>
    <Cmd>DCPromo.ps1</Cmd>
    <Dependency>ADVM</Dependency>
    <Weight>584</Weight>
    <Timeout>3000</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <ADVMIP>{[ADVM]:Nics.Nic.IP}</ADVMIP>
      <ADVMAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</ADVMAdminPassword>
      <DomainName>{[Global]:ADDomainName}</DomainName>
      <DomainNetBios>{[Global]:ADNetBiosName}</DomainNetBios>
      <DomainPassword>{[Global]:AdminPassword}</DomainPassword>
    </Parameters>
  </Task> <!-- DCPromo -->
  <Task> 
    <Name>SetupDNS</Name>
    <Cmd>SetupDNS.ps1</Cmd>
    <CleanupCmd>Sleep.ps1</CleanupCmd>
    <Dependency>DCPromo</Dependency>
    <Weight>9</Weight>
    <Timeout>120</Timeout>
    <Retry>3</Retry>
    <Parameters>
      <SleepTime>60</SleepTime>
      <ADVMIP>{[ADVM]:Nics.Nic.IP}</ADVMIP>
      <ADVMAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</ADVMAdminPassword>      
    </Parameters>
  </Task> <!-- SetupDNS -->
  <Task> 
    <Name>SetupCA</Name>
    <Cmd>SetupCA.ps1</Cmd>
    <CleanupCmd>Sleep.ps1</CleanupCmd>
    <Dependency>AddHostToSG</Dependency>
    <Weight>94</Weight>
    <Retry>3</Retry>
    <Timeout>700</Timeout>
    <Parameters>
      <SleepTime>60</SleepTime>
      <ADVMIP>{[ADVM]:Nics.Nic.IP}</ADVMIP>
      <ADVMAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</ADVMAdminPassword>      
      <CAName>AzureStackCertificationAuthority</CAName>
    </Parameters>
  </Task> <!-- SetupCA -->
  <Task> 
    <Name>CreateServiceAccount</Name>
    <Cmd>CreateServiceAccount.ps1</Cmd>
    <CleanupCmd>Sleep.ps1</CleanupCmd>
    <Dependency>AddHostToSG</Dependency>
    <Weight>6</Weight>
    <Retry>3</Retry>
    <Timeout>200</Timeout>
    <Parameters>
      <SleepTime>60</SleepTime>
      <ADVMIP>{[ADVM]:Nics.Nic.IP}</ADVMIP>
      <DomainAdmin>{[DCPromo]:DomainName}\administrator</DomainAdmin>
      <DomainPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainPassword>
      <ServiceAccounts>asgmsa</ServiceAccounts>
    </Parameters>
  </Task> <!-- CreateServiceAccount -->
  <Task> 
    <Name>DomainJoin</Name>
    <Cmd>DomainJoin.ps1</Cmd>
    <CleanupCmd>Sleep.ps1</CleanupCmd>
    <Dependency>HostConfigration</Dependency> <!-- To ensure reboot happens after power config -->
    <Dependency>SetupDNS</Dependency>
    <Weight>4</Weight>
    <Timeout>120</Timeout>
    <Retry>3</Retry>
    <Parameters>
      <SleepTime>60</SleepTime>
      <DomainName>{[DCPromo]:DomainName}</DomainName>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>      
    </Parameters>
  </Task> <!-- DomainJoin -->
  <Task>
    <Name>ChangeTimeSync</Name>
    <Cmd>ChangeTimeSync.ps1</Cmd>
    <Dependency>DomainJoin</Dependency>
    <Weight>5</Weight>
    <Timeout>60</Timeout>
    <Retry>1</Retry>
  </Task> <!-- ChangeTimeSync-->
  <Task>
    <Name>EnableCredSSP</Name>
    <Cmd>EnableCredSSP.ps1</Cmd>
    <CleanupCmd>Sleep.ps1</CleanupCmd>
    <Dependency>AddHostToSG</Dependency>
    <Weight>14</Weight>
    <Timeout>120</Timeout>
    <Retry>3</Retry>
    <Parameters>
      <SleepTime>60</SleepTime>
      <ADVMIP>{[ADVM]:Nics.Nic.IP}</ADVMIP>
      <DomainName>{[DCPromo]:DomainName}</DomainName>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>  
    </Parameters>
  </Task> <!-- EnableCredSSP-->
  <Task>
    <Name>AddHostToSG</Name>
    <Cmd>AddHostToSG.ps1</Cmd>
    <CleanupCmd>Sleep.ps1</CleanupCmd>
    <Dependency>DomainJoin</Dependency>
    <Weight>20</Weight>
    <Timeout>500</Timeout>
    <Retry>3</Retry>
    <Parameters>
      <SleepTime>60</SleepTime>
      <DomainName>{[DCPromo]:DomainName}</DomainName>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>
      <Group>ComputeNodes</Group>
      <Group>StorageNodes</Group>
    </Parameters>
  </Task> <!-- AddHostToSG-->
  <Task> 
    <Name>CreateFailoverCluster</Name>
    <Cmd>CreateFailoverCluster.ps1</Cmd>
    <Dependency>DomainJoin</Dependency>
    <Dependency>EnableCredSSP</Dependency>
    <Weight>89</Weight>
    <Retry>10</Retry>
    <Timeout>665</Timeout>
    <Parameters>
      <DomainName>{[DCPromo]:DomainName}</DomainName>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>      
      <FCName>ASCluster</FCName>
      <FCIP>192.168.100.8</FCIP>
    </Parameters>
  </Task> <!-- CreateFailoverCluster -->
  <Task> 
    <Name>CreateStoragePool</Name>
    <Cmd>StoragePool.ps1</Cmd>
    <Dependency>CreateFailoverCluster</Dependency>
    <Weight>19</Weight>
    <Timeout>100</Timeout>
    <Retry>3</Retry>
    <Parameters>
      <StoragePoolName>PoCPool</StoragePoolName>
    </Parameters>
  </Task> <!-- CreateStoragePool -->
  <Task> 
    <Name>CreateCSV</Name>
    <Cmd>CreateCSV.ps1</Cmd>
    <CleanupCmd>Sleep.ps1</CleanupCmd>
    <Dependency>CreateStoragePool</Dependency>
    <Weight>37</Weight>
    <Timeout>200</Timeout>
    <Retry>6</Retry>
    <Parameters>
      <SleepTime>60</SleepTime>
      <StoragePoolName>PoCPool</StoragePoolName>
      <vDiskName>PoCPool_VD</vDiskName>
    </Parameters>
  </Task> <!-- CreateCSV -->
  <Task> 
    <Name>CreateSOFS</Name>
    <Cmd>CreateSOFS.ps1</Cmd>
    <Dependency>CreateCSV</Dependency>
    <Weight>91</Weight>
    <Timeout>500</Timeout>
    <Retry>3</Retry>
    <Parameters>
      <DomainName>{[DCPromo]:DomainName}</DomainName>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>      
      <FCIP>{[CreateFailoverCluster]:FCIP}</FCIP>
      <SOFS>
        <DNSName>SOFS</DNSName>
        <ShareName>Share</ShareName>
      </SOFS>
    </Parameters>
  </Task> <!-- CreateSOFS -->
  <Task> 
    <Name>CopyVhdx_SOFS</Name>
    <Cmd>CopyFile.ps1</Cmd>
    <CleanupCmd>Sleep.ps1</CleanupCmd>
    <Weight>332</Weight>
    <Timeout>2000</Timeout>
    <Retry>2</Retry>
    <Dependency>CreateSOFS</Dependency>
    <Parameters>
      <SleepTime>60</SleepTime>
      <File>
        <From>{[Global]:PackagePath}</From>
        <To>C:\ClusterStorage\Volume1\Share\VM</To>
        <FileName>{[Global]:VHDs.OSVHD}</FileName>
      </File>
      <File>
        <From>{[Global]:PackagePath}</From>
        <To>C:\ClusterStorage\Volume1\Share\VM</To>
        <FileName>{[Global]:VHDs.SQLVHD}</FileName>
      </File>
      <File>
        <From>{[Global]:PackagePath}</From>
        <To>C:\ClusterStorage\Volume1\Share\VM</To>
        <FileName>{[Global]:VHDs.PoCVHD}</FileName>
      </File>
      <File>
        <From>{[Global]:PackagePath}</From>
        <To>C:\ClusterStorage\Volume1\Share\VM</To>
        <FileName>{[Global]:VHDs.GalleryVHD}</FileName>
      </File>
    </Parameters>
  </Task> <!-- CopyVhdx_SOFS -->
  <Task> 
    <Name>CreateDSCCert</Name>
    <Cmd>CreateSelfSingedCert.ps1</Cmd>
    <Weight>111</Weight>
    <Retry>2</Retry>
    <Dependency>CreateSOFS</Dependency>
    <Parameters>
      <CertificateType>DocumentEncryptionCert</CertificateType>
      <CertificateProvider>Microsoft RSA SChannel Cryptographic Provider</CertificateProvider>
      <CertificateDnsName>DSCEncryption</CertificateDnsName>
      <CertPassword>{[Global]:AdminPassword}</CertPassword>
      <CertificateFilePath>\\{[CreateSOFS]:SOFS.DNSName}.{[CreateSOFS]:DomainName}\{[CreateSOFS]:SOFS.ShareName}\DSCEncryption\DSCEncryption.pfx</CertificateFilePath>
      <PublicCertificateFilePath>\\{[CreateSOFS]:SOFS.DNSName}.{[CreateSOFS]:DomainName}\{[CreateSOFS]:SOFS.ShareName}\DSCEncryption\DSCEncryption.cer</PublicCertificateFilePath>
    </Parameters>
  </Task> <!-- CreateDSCCert -->
  <Task> 
    <Name>BGPVM</Name>
    <Cmd>CreateVM.ps1</Cmd>
    <Timeout>5400</Timeout>
    <CleanupCmd>DeleteVM.ps1</CleanupCmd>
    <Dependency>CopyVhdx_SOFS</Dependency>
    <Weight>708</Weight>
    <Retry>3</Retry>
    <Parameters>
      <Name>BGPVM</Name>
      <HAVM>true</HAVM>
      <ProcessorCount>2</ProcessorCount>
      <RAM>3</RAM>   
      <MinRAM>2</MinRAM>   
      <MaxRAM>4</MaxRAM>   
      <Disk>
        <Base>{[Global]:VHDs.OSVHD}</Base>        
        <Features>
          <Name>routing</Name>        
        </Features>
      </Disk>
      <Nics>
        <Nic>
          <Name>Nic1</Name>
          <vSwitch>{[SetupvSwitch]:Name}</vSwitch>
          <VLAN>{[Global]:InternalNetworkVLan}</VLAN>
          <DHCP>false</DHCP>
          <IP>192.168.100.1/24</IP>
          <DNSList>
            <DNS>{[Global]:InternalDNS}</DNS>
          </DNSList>
        </Nic>
        <Nic>
          <Name>Nic2</Name>
          <vSwitch>{[SetupvSwitch]:Name}</vSwitch>
          <VLAN>{[Global]:ExternalNetworkVLan}</VLAN>
          <DHCP>false</DHCP>
          <IP>192.168.200.3/24</IP>
          <GW>192.168.200.1</GW>
          <DNSList>
            <DNS>127.0.0.1</DNS>
            <DisableDynamicUpdate>true</DisableDynamicUpdate>
          </DNSList>
        </Nic>
      </Nics>
      <LocalAccounts>
        <AdministratorPassword>{[Global]:AdminPassword}</AdministratorPassword>
      </LocalAccounts>
    </Parameters>
  </Task> <!-- BGPVM -->
  <Task> 
    <Name>NATVM</Name>
    <Cmd>CreateVM.ps1</Cmd>
    <Timeout>4800</Timeout>
    <CleanupCmd>DeleteVM.ps1</CleanupCmd>
    <Dependency>CopyVhdx_SOFS</Dependency>
    <Weight>738</Weight>
    <Retry>3</Retry>
    <Parameters>
      <Name>NATVM</Name>
      <HAVM>true</HAVM>
      <ProcessorCount>2</ProcessorCount>
      <RAM>3</RAM>   
      <MinRAM>2</MinRAM>   
      <MaxRAM>4</MaxRAM>   
      <Disk>
        <Base>{[Global]:VHDs.OSVHD}</Base>        
        <Features>
          <Name>routing</Name>        
        </Features>
      </Disk>
      <Disk>
        <Base>{[Global]:VHDs.PoCVHD}</Base>        
      </Disk>
      <Nics>
        <Nic>
          <Name>Nic1</Name>
          <vSwitch>{[SetupvSwitch]:Name}</vSwitch>
          <VLAN>{[Global]:ExternalNetworkVLan}</VLAN>
          <DHCP>false</DHCP>
          <IP>192.168.200.1/24</IP>
          <DNSList>
            <DNS>{[Global]:InternalDNS}</DNS>
          </DNSList>
        </Nic>
        <Nic>
          <Name>Nic2</Name>
          <vSwitch>{[SetupvSwitch]:Name}</vSwitch>
          <VLAN>{[Global]:PublicVLan}</VLAN>
          <DHCP>{[Global]:NATVMPublicIPFromDHCP}</DHCP>
          <IP>{[Global]:NATVMStaticIP}</IP>
          <GW>{[Global]:NATVMStaticGateway}</GW>
          <DNSList>
            <DNS>127.0.0.1</DNS>
            <DisableDynamicUpdate>true</DisableDynamicUpdate>
          </DNSList>
        </Nic>
      </Nics>
      <LocalAccounts>
        <AdministratorPassword>{[Global]:AdminPassword}</AdministratorPassword>
      </LocalAccounts>
      <PostSetupCmd>powershell.exe /c "New-NetRoute -InterfaceAlias (Get-NetIPAddress | ? {$_.IPAddress -eq '192.168.200.1'}).InterfaceAlias -DestinationPrefix 192.168.100.0/24 -NextHop 192.168.200.3"</PostSetupCmd>
      <PostSetupCmd>powershell.exe /c "New-NetRoute -InterfaceAlias (Get-NetIPAddress | ? {$_.IPAddress -eq '192.168.200.1'}).InterfaceAlias -DestinationPrefix 192.168.133.0/24 -NextHop 192.168.200.3"</PostSetupCmd>
    </Parameters>
  </Task> <!-- NATVM -->
  <Task> 
    <Name>SetupGW</Name>
    <Cmd>SetupGW.ps1</Cmd>
    <Dependency>BGPVM</Dependency>
    <Weight>38</Weight>
    <Timeout>200</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <BGPVMIP>{[BGPVM]:Nics.Nic[0].IP}</BGPVMIP>
      <BGPVMPassword>{[BGPVM]:LocalAccounts.AdministratorPassword}</BGPVMPassword>      
    </Parameters>
  </Task> <!-- SetupGW -->
  <Task> 
    <Name>SetupNAT</Name>
    <Cmd>SetupNAT.ps1</Cmd>
    <Dependency>NATVM</Dependency>
    <Retry>1</Retry>
    <Weight>15</Weight>
    <Timeout>700</Timeout>
    <Parameters>
      <NATVMIP>{[NATVM]:Nics.Nic[0].IP}</NATVMIP>
      <NATVMPassword>{[NATVM]:LocalAccounts.AdministratorPassword}</NATVMPassword>      
      <ADVMIP>{[ADVM]:Nics.Nic.IP}</ADVMIP>
    </Parameters>
  </Task> <!-- SetupNAT -->
  <Task> 
    <Name>NCVM</Name>
    <Cmd>CreateVM.ps1</Cmd>
    <CleanupCmd>DeleteVM.ps1</CleanupCmd>
    <Dependency>CopyVhdx_SOFS</Dependency>
    <Dependency>CreateDSCCert</Dependency>
    <Weight>700</Weight>
    <Timeout>5400</Timeout>
    <Retry>3</Retry>
    <Parameters>
      <Name>NCVM</Name>
      <HAVM>true</HAVM>
      <ProcessorCount>2</ProcessorCount>
      <RAM>3</RAM>   
      <MinRAM>2</MinRAM>   
      <MaxRAM>4</MaxRAM>   
      <Disk>
        <Base>{[Global]:VHDs.OSVHD}</Base>        
        <Features>
          <Name>NetworkController,RSAT-NetworkController</Name>        
        </Features>
        <File>
          <From>{[CreateDSCCert]:CertificateFilePath}</From>
          <To>DSCEncryption.pfx</To>
        </File>
      </Disk>
      <Disk>
        <Base>{[Global]:VHDs.PoCVHD}</Base>        
      </Disk>
      <Nics>
        <Nic>
          <Name>Nic1</Name>
          <vSwitch>{[SetupvSwitch]:Name}</vSwitch>
          <VLAN>{[Global]:InternalNetworkVLan}</VLAN>
          <DHCP>false</DHCP>
          <IP>192.168.100.4/24</IP>
          <GW>{[Global]:InternalGW}</GW>
          <DNSList>
            <DNS>{[Global]:InternalDNS}</DNS>
          </DNSList>
        </Nic>
      </Nics>
      <Domain>
        <DomainName>{[DCPromo]:DomainName}</DomainName>
        <User>administrator</User>
        <Password>{[ADVM]:LocalAccounts.AdministratorPassword}</Password>
      </Domain>
      <LocalAccounts>
        <AdministratorPassword>{[Global]:AdminPassword}</AdministratorPassword>
      </LocalAccounts>
    </Parameters>
  </Task> <!-- NCVM -->
  <Task> 
    <Name>MuxVM</Name>
    <Cmd>CreateVM.ps1</Cmd>
    <CleanupCmd>DeleteVM.ps1</CleanupCmd>
    <Dependency>CopyVhdx_SOFS</Dependency>
    <Dependency>CreateDSCCert</Dependency>
    <Weight>693</Weight>
    <Retry>3</Retry>
    <Timeout>5400</Timeout>
    <Parameters>
      <Name>MuxVM</Name>
      <HAVM>true</HAVM>
      <ProcessorCount>2</ProcessorCount>
      <RAM>3</RAM>   
      <MinRAM>2</MinRAM>   
      <MaxRAM>4</MaxRAM>   
      <Disk>
        <Base>{[Global]:VHDs.OSVHD}</Base>        
        <Features>
          <Name>NetworkController,RSAT-NetworkController</Name>      
        </Features>
        <File>
          <From>{[CreateDSCCert]:CertificateFilePath}</From>
          <To>DSCEncryption.pfx</To>
        </File>
      </Disk>
      <Nics>
        <Nic>
          <Name>Nic1</Name>
          <vSwitch>{[SetupvSwitch]:Name}</vSwitch>
          <VLAN>{[Global]:InternalNetworkVLan}</VLAN>
          <DHCP>false</DHCP>
          <IP>192.168.100.5/24</IP>
          <GW>{[Global]:InternalGW}</GW>
          <DNSList>
            <DNS>{[Global]:InternalDNS}</DNS>
          </DNSList>
        </Nic>
      </Nics>
      <Domain>
        <DomainName>{[DCPromo]:DomainName}</DomainName>
        <User>administrator</User>
        <Password>{[ADVM]:LocalAccounts.AdministratorPassword}</Password>
      </Domain>
      <LocalAccounts>
        <AdministratorPassword>{[Global]:AdminPassword}</AdministratorPassword>
      </LocalAccounts>
    </Parameters>
  </Task> <!-- MuxVM -->
  <Task> 
    <Name>ImportDCSCert_NCVM</Name>
    <Cmd>ImportCert.ps1</Cmd>
    <Weight>111</Weight>
    <Retry>2</Retry>
    <Dependency>NCVM</Dependency>
    <Parameters>
      <Server>{[NCVM]:Name}.{[Global]:ADDomainName}</Server>
      <AdminPassword>{[NCVM]:LocalAccounts.AdministratorPassword}</AdminPassword>
      <CertFilePath>C:\{[NCVM]:Disk[0].File.To}</CertFilePath>
      <CertificateStore>cert:\LocalMachine\my</CertificateStore>
      <CertPassword>{[CreateDSCCert]:CertPassword}</CertPassword>
    </Parameters>
  </Task> <!-- ImportDCSCert_NCVM -->
  <Task> 
    <Name>SetupNC</Name>
    <Cmd>SetupNC.ps1</Cmd>
    <Dependency>ImportDCSCert_NCVM</Dependency>
    <Weight>597</Weight>
    <Timeout>3000</Timeout>
    <Retry>8</Retry>
    <Parameters>
      <DSCCertPath>{[CreateDSCCert]:PublicCertificateFilePath}</DSCCertPath>
      <FQDN>{[Global]:ADDomainName}</FQDN>
      <SOFS>{[CreateSOFS]:SOFS.DNSName}</SOFS>
      <ShareName>{[CreateSOFS]:SOFS.ShareName}</ShareName>
      <NCName>{[NCVM]:Name}</NCName>
      <NCVMIP>{[NCVM]:Nics.Nic.IP}</NCVMIP>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>     

      <PAIsolationID>{[Global]:InternalNetworkVLan}</PAIsolationID>
      <PALogicalNetworkSubnet>192.168.100.0/24</PALogicalNetworkSubnet>
      <PALogicalNetworkDNS>{[Global]:InternalDNS}</PALogicalNetworkDNS>
      <PALogicalNetworkGW>{[Global]:InternalGW}</PALogicalNetworkGW>
      <PALogicalNetworkPoolStart>192.168.100.230</PALogicalNetworkPoolStart> <!-- These IPs for VM host HNV usage -->
      <PALogicalNetworkPoolEnd>192.168.100.240</PALogicalNetworkPoolEnd>

      <VIPLogicalNetworkSubnet>192.168.133.0/24</VIPLogicalNetworkSubnet>
      <VIPLogicalNetworkGW>192.168.133.1</VIPLogicalNetworkGW>
      <VIPLogicalNetworkPoolStart>192.168.133.20</VIPLogicalNetworkPoolStart>
      <VIPLogicalNetworkPoolEnd>192.168.133.100</VIPLogicalNetworkPoolEnd>

      <TransitIsolationID>{[Global]:ExternalNetworkVLan}</TransitIsolationID>
      <TransitLogicalNetworkSubnet>192.168.200.0/24</TransitLogicalNetworkSubnet>
      <TransitLogicalNetworkDNS>{[Global]:InternalDNS}</TransitLogicalNetworkDNS>
      <TransitLogicalNetworkGW>192.168.200.1</TransitLogicalNetworkGW>
      <TransitLogicalNetworkPoolStart>192.168.200.50</TransitLogicalNetworkPoolStart>
      <TransitLogicalNetworkPoolEnd>192.168.200.200</TransitLogicalNetworkPoolEnd>

      <SLBOutboundNatIPExemption>192.168.100.3/32</SLBOutboundNatIPExemption>
      <SLBOutboundNatIPExemption>192.168.100.4/30</SLBOutboundNatIPExemption>
      <SLBOutboundNatIPExemption>192.168.100.8/29</SLBOutboundNatIPExemption>
      <SLBOutboundNatIPExemption>192.168.100.16/28</SLBOutboundNatIPExemption>
      <SLBOutboundNatIPExemption>192.168.100.32/27</SLBOutboundNatIPExemption>
      <SLBOutboundNatIPExemption>192.168.100.64/26</SLBOutboundNatIPExemption>
      <SLBOutboundNatIPExemption>192.168.100.128/25</SLBOutboundNatIPExemption>

      <ToolsSrcLocation>Tools</ToolsSrcLocation>
      <CertFolder>Certs</CertFolder>
      <ScriptFolder>Scripts</ScriptFolder>
      <NCCertName>NetworkControllerRootCertificate.cer</NCCertName>
      <ToolsLocation>C:\Tools</ToolsLocation>
      <MACAddressPoolStart>00-1D-D8-B7-1C-00</MACAddressPoolStart>
      <MACAddressPoolEnd>00-1D-D8-F4-1F-FF</MACAddressPoolEnd>
      <NCCredentialResourceId>{[Global]:ResourceIDs.NCCredentialResourceId}</NCCredentialResourceId>
      <HostCredentialResourceId>{[Global]:ResourceIDs.HostCredentialResourceId}</HostCredentialResourceId>
      <PALogicalNetworkResourceId>{[Global]:ResourceIDs.PALogicalNetworkResourceId}</PALogicalNetworkResourceId>
      <TransitLogicalNetworkResourceId>{[Global]:ResourceIDs.TransitLogicalNetworkResourceId}</TransitLogicalNetworkResourceId>
      <VIPLogicalNetworkResourceId>{[Global]:ResourceIDs.VIPLogicalNetworkResourceId}</VIPLogicalNetworkResourceId>
      <MACAddressPoolResourceId>{[Global]:ResourceIDs.MACAddressPoolResourceId}</MACAddressPoolResourceId>
      <MuxVirtualServerResourceId>{[Global]:ResourceIDs.MuxVirtualServerResourceId}</MuxVirtualServerResourceId>
      <MuxResourceId>{[Global]:ResourceIDs.MuxResourceId}</MuxResourceId>
      <AclResourceId>{[Global]:ResourceIDs.AclResourceId}</AclResourceId>
    </Parameters>
  </Task> <!-- SetupNC -->
  <Task> 
    <Name>SQLVM</Name>
    <Cmd>CreateVM.ps1</Cmd>
    <CleanupCmd>DeleteVM.ps1</CleanupCmd>
    <Dependency>CopyVhdx_SOFS</Dependency>
    <Weight>672</Weight>
    <Timeout>5400</Timeout>
    <Retry>3</Retry>
    <Parameters>
      <Name>SQLVM</Name>
      <HAVM>true</HAVM>
      <Group>SQLVMs</Group>
      <ProcessorCount>4</ProcessorCount>
      <RAM>3</RAM>   
      <MinRAM>2</MinRAM>   
      <MaxRAM>4</MaxRAM>   
      <Disk>
        <Base>{[Global]:VHDs.OSVHD}</Base>        
      </Disk>
      <Disk>
        <Base>{[Global]:VHDs.PoCVHD}</Base>        
      </Disk>
      <Disk>
        <Base>{[Global]:VHDs.SQLVHD}</Base>        
      </Disk>
      <Nics>
        <Nic>
          <Name>Nic1</Name>
          <vSwitch>{[SetupvSwitch]:Name}</vSwitch>
          <VLAN>{[Global]:InternalNetworkVLan}</VLAN>
          <DHCP>false</DHCP>
          <IP>192.168.100.11/24</IP>
          <GW>{[Global]:InternalGW}</GW>
          <DNSList>
            <DNS>{[Global]:InternalDNS}</DNS>
          </DNSList>
        </Nic>
      </Nics>
      <Domain>
        <DomainName>{[DCPromo]:DomainName}</DomainName>
        <User>administrator</User>
        <Password>{[ADVM]:LocalAccounts.AdministratorPassword}</Password>
      </Domain>
      <LocalAccounts>
        <AdministratorPassword>{[Global]:AdminPassword}</AdministratorPassword>
      </LocalAccounts>
      <RegKeys>
        <Reg><!-- Disable windows update-->
          <Operation>Add</Operation>
          <Path>System\ControlSet001\Services\wuauserv</Path>
          <Value>Start</Value>
          <Type>REG_DWORD</Type>
          <Data>4</Data>
        </Reg>
        <Reg>
          <Operation>Add</Operation>
          <Path>System\ControlSet002\Services\wuauserv</Path>
          <Value>Start</Value>
          <Type>REG_DWORD</Type>
          <Data>4</Data>
        </Reg>
      </RegKeys>
    </Parameters>
  </Task> <!-- SQLVM -->
  <Task> 
    <Name>PortalVM</Name>
    <Cmd>CreateVM.ps1</Cmd>
    <CleanupCmd>DeleteVM.ps1</CleanupCmd>
    <Dependency>CopyVhdx_SOFS</Dependency>
    <Weight>424</Weight>
    <Retry>3</Retry>
    <Timeout>5400</Timeout>
    <Parameters>
      <Name>PortalVM</Name>
      <HAVM>true</HAVM>
      <Group>PortalVMs</Group>
      <ProcessorCount>4</ProcessorCount>
      <RAM>4</RAM>   
      <MinRAM>3</MinRAM>   
      <MaxRAM>6</MaxRAM>   
      <Disk>
        <Base>{[Global]:VHDs.OSVHD}</Base>        
      </Disk>
      <Disk>
        <Base>{[Global]:VHDs.PoCVHD}</Base>        
      </Disk>
      <ProxyServer>{[Global]:ProxyServer}</ProxyServer>
      <Nics>
        <Nic>
          <Name>Nic1</Name>
          <vSwitch>{[SetupvSwitch]:Name}</vSwitch>
          <VLAN>{[Global]:InternalNetworkVLan}</VLAN>
          <DHCP>false</DHCP>
          <IP>192.168.100.12/24</IP>
          <GW>{[Global]:InternalGW}</GW>
          <DNSList>
            <DNS>{[Global]:InternalDNS}</DNS>
          </DNSList>
        </Nic>
      </Nics>
      <RegKeys>
        <Reg><!-- Disable windows update-->
          <Operation>Add</Operation>
          <Path>System\ControlSet001\Services\wuauserv</Path>
          <Value>Start</Value>
          <Type>REG_DWORD</Type>
          <Data>4</Data>
        </Reg>
        <Reg>
          <Operation>Add</Operation>
          <Path>System\ControlSet002\Services\wuauserv</Path>
          <Value>Start</Value>
          <Type>REG_DWORD</Type>
          <Data>4</Data>
        </Reg>
      </RegKeys>
      <Domain>
        <DomainName>{[DCPromo]:DomainName}</DomainName>
        <User>administrator</User>
        <Password>{[ADVM]:LocalAccounts.AdministratorPassword}</Password>
      </Domain>
      <LocalAccounts>
        <AdministratorPassword>{[Global]:AdminPassword}</AdministratorPassword>
      </LocalAccounts>
    </Parameters>
  </Task> <!-- PortalVM -->
  <Task> 
    <Name>ACSVM</Name>
    <Cmd>CreateVM.ps1</Cmd>
    <CleanupCmd>DeleteVM.ps1</CleanupCmd>
    <Dependency>CopyVhdx_SOFS</Dependency>
    <Weight>562</Weight>
    <Retry>3</Retry>
    <Timeout>5400</Timeout>
    <Parameters>
      <Name>ACSVM</Name>
      <HAVM>true</HAVM>
      <Group>ACSVMs</Group>
      <ProcessorCount>4</ProcessorCount>
      <RAM>6</RAM>   
      <MinRAM>4</MinRAM>   
      <MaxRAM>8</MaxRAM>   
      <Disk>
        <Base>{[Global]:VHDs.OSVHD}</Base>        
      </Disk>
      <Disk>
        <Base>{[Global]:VHDs.PoCVHD}</Base>        
      </Disk>
      <Nics>
        <Nic>
          <Name>Nic1</Name>
          <vSwitch>{[SetupvSwitch]:Name}</vSwitch>
          <VLAN>{[Global]:InternalNetworkVLan}</VLAN>
          <DHCP>false</DHCP>
          <IP>192.168.100.13/24</IP>
          <GW>{[Global]:InternalGW}</GW>
          <DNSList>
            <DNS>{[Global]:InternalDNS}</DNS>
          </DNSList>
        </Nic>
      </Nics>
      <RegKeys>
        <Reg><!-- Disable windows update-->
          <Operation>Add</Operation>
          <Path>System\ControlSet001\Services\wuauserv</Path>
          <Value>Start</Value>
          <Type>REG_DWORD</Type>
          <Data>4</Data>
        </Reg>
        <Reg>
          <Operation>Add</Operation>
          <Path>System\ControlSet002\Services\wuauserv</Path>
          <Value>Start</Value>
          <Type>REG_DWORD</Type>
          <Data>4</Data>
        </Reg>              
      </RegKeys>
      <Domain>
        <DomainName>{[DCPromo]:DomainName}</DomainName>
        <User>administrator</User>
        <Password>{[ADVM]:LocalAccounts.AdministratorPassword}</Password>
      </Domain>
      <LocalAccounts>
        <AdministratorPassword>{[Global]:AdminPassword}</AdministratorPassword>
      </LocalAccounts>
    </Parameters>
  </Task> <!-- ACSVM -->
  <Task> 
    <Name>xRPVM</Name>
    <Cmd>CreateVM.ps1</Cmd>
    <CleanupCmd>DeleteVM.ps1</CleanupCmd>
    <Dependency>CopyVhdx_SOFS</Dependency>
    <Weight>744</Weight>
    <Retry>3</Retry>
    <Timeout>5400</Timeout>
    <Parameters>
      <Name>xRPVM</Name>
      <Group>xRPVMs</Group>
      <HAVM>true</HAVM>
      <ProcessorCount>4</ProcessorCount>
      <RAM>6</RAM>   
      <MinRAM>4</MinRAM>   
      <MaxRAM>8</MaxRAM>   
      <Disk>
        <Base>{[Global]:VHDs.OSVHD}</Base>        
        <Features>
          <Name>Web-Server,Web-Asp-Net45</Name>        
        </Features>
      </Disk>
      <Disk>
        <Base>{[Global]:VHDs.PoCVHD}</Base>        
      </Disk>
      <ProxyServer>{[Global]:ProxyServer}</ProxyServer>
      <Nics>
        <Nic>
          <Name>Nic1</Name>
          <vSwitch>{[SetupvSwitch]:Name}</vSwitch>
          <VLAN>{[Global]:InternalNetworkVLan}</VLAN>
          <DHCP>false</DHCP>
          <IP>192.168.100.14/24</IP>
          <GW>{[Global]:InternalGW}</GW>
          <DNSList>
            <DNS>{[Global]:InternalDNS}</DNS>
          </DNSList>
        </Nic>
      </Nics>
      <RegKeys>
        <Reg><!-- Disable windows update-->
          <Operation>Add</Operation>
          <Path>System\ControlSet001\Services\wuauserv</Path>
          <Value>Start</Value>
          <Type>REG_DWORD</Type>
          <Data>4</Data>
        </Reg>
        <Reg>
          <Operation>Add</Operation>
          <Path>System\ControlSet002\Services\wuauserv</Path>
          <Value>Start</Value>
          <Type>REG_DWORD</Type>
          <Data>4</Data>
        </Reg>
      </RegKeys>
      <Domain>
        <DomainName>{[DCPromo]:DomainName}</DomainName>
        <User>administrator</User>
        <Password>{[ADVM]:LocalAccounts.AdministratorPassword}</Password>
      </Domain>
      <LocalAccounts>
        <AdministratorPassword>{[Global]:AdminPassword}</AdministratorPassword>
      </LocalAccounts>
    </Parameters>
  </Task> <!-- xRPVM -->
  <Task> 
    <Name>ClientVM</Name>
    <Cmd>CreateVM.ps1</Cmd>
    <CleanupCmd>DeleteVM.ps1</CleanupCmd>
    <Dependency>SetupGW</Dependency>
    <Weight>333</Weight>
    <Retry>3</Retry>
    <Timeout>5400</Timeout>
    <Parameters>
      <Name>ClientVM</Name>
      <HAVM>true</HAVM>
      <Group>ClientVMs</Group>
      <ProcessorCount>2</ProcessorCount>
      <RAM>3</RAM>   
      <MinRAM>2</MinRAM>   
      <MaxRAM>4</MaxRAM>   
      <Disk>
        <Base>{[Global]:VHDs.OSVHD}</Base>        
      </Disk>
      <Disk>
        <Base>{[Global]:VHDs.PoCVHD}</Base>        
      </Disk>
      <ProxyServer>{[Global]:ProxyServer}</ProxyServer>
      <Nics>
        <Nic>
          <Name>Nic1</Name>
          <vSwitch>{[SetupvSwitch]:Name}</vSwitch>
          <VLAN>{[Global]:ExternalNetworkVLan}</VLAN>
          <DHCP>false</DHCP>
          <IP>192.168.200.101/24</IP>
          <GW>192.168.200.3</GW>
          <DNSList>
            <DNS>{[Global]:InternalDNS}</DNS>
          </DNSList>
        </Nic>
      </Nics>
      <Domain>
        <DomainName>{[DCPromo]:DomainName}</DomainName>
        <User>administrator</User>
        <Password>{[ADVM]:LocalAccounts.AdministratorPassword}</Password>
      </Domain>
      <LocalAccounts>
        <AdministratorPassword>{[Global]:AdminPassword}</AdministratorPassword>
      </LocalAccounts>
      <RegKeys>
        <Reg><!-- Disable windows update-->
          <Operation>Add</Operation>
          <Path>System\ControlSet001\Services\wuauserv</Path>
          <Value>Start</Value>
          <Type>REG_DWORD</Type>
          <Data>4</Data>
        </Reg>
        <Reg>
          <Operation>Add</Operation>
          <Path>System\ControlSet002\Services\wuauserv</Path>
          <Value>Start</Value>
          <Type>REG_DWORD</Type>
          <Data>4</Data>
        </Reg>
      </RegKeys>
    </Parameters>
  </Task> <!-- ClientVM -->
  <Task> 
    <Name>SetupBGP</Name>
    <Cmd>SetupBGP.ps1</Cmd>
    <Dependency>SetupGW</Dependency>
    <Dependency>MuxVM</Dependency>
    <Weight>13</Weight>
    <Timeout>100</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <BGPVMIP>{[BGPVM]:Nics.Nic[0].IP}</BGPVMIP>
      <BGPVMPassword>{[BGPVM]:LocalAccounts.AdministratorPassword}</BGPVMPassword>      
      <MuxVMIP>{[MuxVM]:Nics.Nic.IP}</MuxVMIP>      
      <vIPRange>192.168.133.0/24</vIPRange>
      <BGPASN>64627</BGPASN>
      <MuxASN>64612</MuxASN>
    </Parameters>
  </Task> <!-- SetupBGP -->
  <Task> 
    <Name>ImportDCSCert_MuxVM</Name>
    <Cmd>ImportCert.ps1</Cmd>
    <Weight>111</Weight>
    <Retry>2</Retry>
    <Dependency>MuxVM</Dependency>
    <Parameters>
      <Server>{[MuxVM]:Name}.{[Global]:ADDomainName}</Server>
      <AdminPassword>{[MuxVM]:LocalAccounts.AdministratorPassword}</AdminPassword>
      <CertFilePath>C:\{[MuxVM]:Disk.File.To}</CertFilePath>
      <CertificateStore>cert:\LocalMachine\my</CertificateStore>
      <CertPassword>{[CreateDSCCert]:CertPassword}</CertPassword>
    </Parameters>
  </Task> <!-- ImportDCSCert_MuxVM -->
  <Task> 
    <Name>SetupMux</Name>
    <Cmd>SetupMux.ps1</Cmd>
    <Dependency>SetupNC</Dependency>
    <Dependency>ImportDCSCert_MuxVM</Dependency>
    <Weight>39</Weight>
    <Retry>3</Retry>
    <Timeout>250</Timeout>
    <Parameters>
      <DSCCertPath>{[CreateDSCCert]:PublicCertificateFilePath}</DSCCertPath>
      <MuxVMName>{[MuxVM]:Name}</MuxVMName>
      <FQDN>{[Global]:ADDomainName}</FQDN>
      <SOFS>{[CreateSOFS]:SOFS.DNSName}</SOFS>
      <ShareName>{[CreateSOFS]:SOFS.ShareName}</ShareName>
      <NCName>{[NCVM]:Name}</NCName>
      <NCVMIP>{[NCVM]:Nics.Nic.IP}</NCVMIP>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>     
      <ToolsSrcLocation>{[SetupNC]:ToolsSrcLocation}</ToolsSrcLocation>
      <CertFolder>{[SetupNC]:CertFolder}</CertFolder>
      <ScriptFolder>{[SetupNC]:ScriptFolder}</ScriptFolder>
      <NCCertName>{[SetupNC]:NCCertName}</NCCertName>
      <NCCredentialResourceId>{[Global]:ResourceIDs.NCCredentialResourceId}</NCCredentialResourceId>
      <HostCredentialResourceId>{[Global]:ResourceIDs.HostCredentialResourceId}</HostCredentialResourceId>
      <PALogicalNetworkResourceId>{[Global]:ResourceIDs.PALogicalNetworkResourceId}</PALogicalNetworkResourceId>
      <VIPLogicalNetworkResourceId>{[Global]:ResourceIDs.VIPLogicalNetworkResourceId}</VIPLogicalNetworkResourceId>
      <MACAddressPoolResourceId>{[Global]:ResourceIDs.MACAddressPoolResourceId}</MACAddressPoolResourceId>
      <MuxVirtualServerResourceId>{[Global]:ResourceIDs.MuxVirtualServerResourceId}</MuxVirtualServerResourceId>
      <MuxResourceId>{[Global]:ResourceIDs.MuxResourceId}</MuxResourceId>
      <AclResourceId>{[Global]:ResourceIDs.AclResourceId}</AclResourceId>
      <MuxPeerRouterName>{[BGPVM]:Name}</MuxPeerRouterName>
      <MuxPeerRouterIP>{[Global]:InternalGW}</MuxPeerRouterIP>
      <BGPASN>{[SetupBGP]:BGPASN}</BGPASN>
      <MuxASN>{[SetupBGP]:MuxASN}</MuxASN>
    </Parameters>
  </Task> <!-- SetupMux -->
  <Task> 
    <Name>ConfigureHostNetworking</Name>
    <Cmd>ConfigureHostNetworking.ps1</Cmd>
    <Dependency>SetupMux</Dependency>
    <Weight>36</Weight>
    <Timeout>200</Timeout>
    <Retry>2</Retry>
    <Parameters>
      <DSCCertPath>{[CreateDSCCert]:PublicCertificateFilePath}</DSCCertPath>
      <FQDN>{[Global]:ADDomainName}</FQDN>
      <SOFS>{[CreateSOFS]:SOFS.DNSName}</SOFS>
      <ShareName>{[CreateSOFS]:SOFS.ShareName}</ShareName>
      <NCName>{[NCVM]:Name}</NCName>
      <NCVMIP>{[NCVM]:Nics.Nic.IP}</NCVMIP>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>     
      <PAIsolationID>{[Global]:InternalNetworkVLan}</PAIsolationID>
      <VIPLogicalNetworkPoolStart>{[SetupNC]:VIPLogicalNetworkPoolStart}</VIPLogicalNetworkPoolStart>
      <ToolsSrcLocation>{[SetupNC]:ToolsSrcLocation}</ToolsSrcLocation>
      <CertFolder>{[SetupNC]:CertFolder}</CertFolder>
      <ScriptFolder>{[SetupNC]:ScriptFolder}</ScriptFolder>
      <NCCertName>{[SetupNC]:NCCertName}</NCCertName>
      <ToolsLocation>{[SetupNC]:ToolsLocation}</ToolsLocation>
      <NCCredentialResourceId>{[Global]:ResourceIDs.NCCredentialResourceId}</NCCredentialResourceId>
      <HostCredentialResourceId>{[Global]:ResourceIDs.HostCredentialResourceId}</HostCredentialResourceId>
      <PALogicalNetworkResourceId>{[Global]:ResourceIDs.PALogicalNetworkResourceId}</PALogicalNetworkResourceId>
      <VIPLogicalNetworkResourceId>{[Global]:ResourceIDs.VIPLogicalNetworkResourceId}</VIPLogicalNetworkResourceId>
      <MACAddressPoolResourceId>{[Global]:ResourceIDs.MACAddressPoolResourceId}</MACAddressPoolResourceId>
      <MuxVirtualServerResourceId>{[Global]:ResourceIDs.MuxVirtualServerResourceId}</MuxVirtualServerResourceId>
      <MuxResourceId>{[Global]:ResourceIDs.MuxResourceId}</MuxResourceId>
      <AclResourceId>{[Global]:ResourceIDs.AclResourceId}</AclResourceId>
      <vSwitchName>{[SetupvSwitch]:Name}</vSwitchName>
      <HostInternalNic>{[SetupvSwitch]:AdditionalHostNic.Name}</HostInternalNic>
      <HostIP>{[SetupvSwitch]:AdditionalHostNic.IP}</HostIP>
    </Parameters>
  </Task> <!-- ConfigureHostNetworking -->
  <Task> 
    <Name>AddVMtoNC_ACSVM</Name>
    <Cmd>AddVMtoNC.ps1</Cmd>
    <Dependency>ConfigureHostNetworking</Dependency>
    <Dependency>ACSVM</Dependency>
    <Weight>4</Weight>
    <Timeout>60</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <NCName>{[NCVM]:Name}</NCName>
      <FQDN>{[Global]:ADDomainName}</FQDN>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>     
      <VMName>{[ACSVM]:Name}</VMName>
      <NicName>{[ACSVM]:Nics.Nic.Name}</NicName>
      <IP>{[ACSVM]:Nics.Nic.IP}</IP>
      <PortProfileId>5b897d6a-9e7c-47ca-a80a-a96d968fc574</PortProfileId>
      <NetworkResourceId>{[Global]:ResourceIDs.PALogicalNetworkResourceId}</NetworkResourceId>
      <DNSServer>{[Global]:InternalDNS}</DNSServer>
      <AclResourceId>{[Global]:ResourceIDs.AclResourceId}</AclResourceId>
    </Parameters>
  </Task> <!-- AddVMtoNC_ACSVM -->
  <Task> 
    <Name>AddVMtoNC_PortalVM</Name>
    <Cmd>AddVMtoNC.ps1</Cmd>
    <Dependency>ConfigureHostNetworking</Dependency>
    <Dependency>PortalVM</Dependency>
    <Weight>4</Weight>
    <Timeout>60</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <NCName>{[NCVM]:Name}</NCName>
      <FQDN>{[Global]:ADDomainName}</FQDN>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>     
      <VMName>{[PortalVM]:Name}</VMName>
      <NicName>{[PortalVM]:Nics.Nic.Name}</NicName>
      <IP>{[PortalVM]:Nics.Nic.IP}</IP>
      <PortProfileId>d1ab2891-edda-41b8-8c61-ec71b5dd875c</PortProfileId>
      <NetworkResourceId>{[Global]:ResourceIDs.PALogicalNetworkResourceId}</NetworkResourceId>
      <DNSServer>{[Global]:InternalDNS}</DNSServer>
      <AclResourceId>{[Global]:ResourceIDs.AclResourceId}</AclResourceId>
    </Parameters>
  </Task> <!-- AddVMtoNC_PortalVM -->
  <Task> 
    <Name>AddVMtoNC_SQLVM</Name>
    <Cmd>AddVMtoNC.ps1</Cmd>
    <Dependency>ConfigureHostNetworking</Dependency>
    <Dependency>SQLVM</Dependency>
    <Weight>4</Weight>
    <Timeout>60</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <NCName>{[NCVM]:Name}</NCName>
      <FQDN>{[Global]:ADDomainName}</FQDN>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>     
      <VMName>{[SQLVM]:Name}</VMName>
      <NicName>{[SQLVM]:Nics.Nic.Name}</NicName>
      <IP>{[SQLVM]:Nics.Nic.IP}</IP>
      <PortProfileId>4bd166fd-45aa-4bec-9c7f-e0a53faa7e6b</PortProfileId>
      <NetworkResourceId>{[Global]:ResourceIDs.PALogicalNetworkResourceId}</NetworkResourceId>
      <DNSServer>{[Global]:InternalDNS}</DNSServer>
      <AclResourceId>{[Global]:ResourceIDs.AclResourceId}</AclResourceId>
    </Parameters>
  </Task> <!-- AddVMtoNC_SQLVM -->
  <Task> 
    <Name>AddVMtoNC_xRPVM</Name>
    <Cmd>AddVMtoNC.ps1</Cmd>
    <Dependency>ConfigureHostNetworking</Dependency>
    <Dependency>xRPVM</Dependency>
    <Weight>4</Weight>
    <Timeout>60</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <NCName>{[NCVM]:Name}</NCName>
      <FQDN>{[Global]:ADDomainName}</FQDN>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>     
      <VMName>{[xRPVM]:Name}</VMName>
      <NicName>{[xRPVM]:Nics.Nic.Name}</NicName>
      <IP>{[xRPVM]:Nics.Nic.IP}</IP>
      <PortProfileId>c899e05a-6abf-4fa0-af69-f7e3388e8e8a</PortProfileId>
      <NetworkResourceId>{[Global]:ResourceIDs.PALogicalNetworkResourceId}</NetworkResourceId>
      <DNSServer>{[Global]:InternalDNS}</DNSServer>
      <AclResourceId>{[Global]:ResourceIDs.AclResourceId}</AclResourceId>
    </Parameters>
  </Task> <!-- AddVMtoNC_xRPVM -->
  <!-- Internal Vip -->
  <Task> 
    <Name>AddLoadBalancer_xRPInternal</Name> <!-- 31 -->
    <Cmd>AddLoadBalancer.ps1</Cmd>
    <Dependency>SetupMux</Dependency>
    <Dependency>AddVMtoNC_xRPVM</Dependency>
    <Weight>4</Weight>
    <Timeout>300</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <NCName>{[NCVM]:Name}</NCName>
      <FQDN>{[Global]:ADDomainName}</FQDN>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>     
      <VIPLogicalNetworkResourceId>{[Global]:ResourceIDs.VIPLogicalNetworkResourceId}</VIPLogicalNetworkResourceId>
      <Vip>192.168.133.31</Vip>
      <Rule> <!-- SRP:30020 -->
        <FrontendPort>30020</FrontendPort>
        <BackendPort>30020</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- NRP:443 -->
        <FrontendPort>443</FrontendPort>
        <BackendPort>443</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- CRP Manifest Provider :14005 -->
        <FrontendPort>14005</FrontendPort>
        <BackendPort>14005</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- CRP:83 -->
        <FrontendPort>83</FrontendPort>
        <BackendPort>83</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- CRP Platform Image Repository:14011 -->
        <FrontendPort>14011</FrontendPort>
        <BackendPort>14011</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- CRP Metadata Server:14020 -->
        <FrontendPort>14020</FrontendPort>
        <BackendPort>14020</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- CRP Guest Artifact Repository:14021 -->
        <FrontendPort>14021</FrontendPort>
        <BackendPort>14021</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- CRP Topology Manager:14002 -->
        <FrontendPort>14002</FrontendPort>
        <BackendPort>14002</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- CRP Cluster Manager :14003-->
        <FrontendPort>14003</FrontendPort>
        <BackendPort>14003</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- CRP Compute Controller :14004 -->
        <FrontendPort>14004</FrontendPort>
        <BackendPort>14004</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- CRP Blob Manager:14006 -->
        <FrontendPort>14006</FrontendPort>
        <BackendPort>14006</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- CRP ISO Manager:14007 -->
        <FrontendPort>14007</FrontendPort>
        <BackendPort>14007</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- CRP Extension Manager:14008 -->
        <FrontendPort>14008</FrontendPort>
        <BackendPort>14008</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- CRP Placement Manager:14009-->
        <FrontendPort>14009</FrontendPort>
        <BackendPort>14009</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- CRP Availability Set Controller:14010 -->
        <FrontendPort>14010</FrontendPort>
        <BackendPort>14010</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- CRP Network Manager:14015 -->
        <FrontendPort>14015</FrontendPort>
        <BackendPort>14015</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- CRP Diagnostics Manager:14012 -->
        <FrontendPort>14012</FrontendPort>
        <BackendPort>14012</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
    </Parameters>
  </Task> <!-- AddLoadBalancer_xRPInternal[31] SRP:30020 NRP:443 CRP:14005 83-->
  <Task>
    <Name>AddLoadBalancer_WAPInternal</Name>
    <Cmd>AddLoadBalancer.ps1</Cmd>
    <Dependency>SetupMux</Dependency>
    <Dependency>AddVMtoNC_PortalVM</Dependency>
    <Weight>14</Weight>
    <Timeout>300</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <NCName>{[NCVM]:Name}</NCName>
      <FQDN>{[Global]:ADDomainName}</FQDN>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>     
      <VIPLogicalNetworkResourceId>{[Global]:ResourceIDs.VIPLogicalNetworkResourceId}</VIPLogicalNetworkResourceId>
      <Vip>192.168.133.32</Vip>
      <Rule> <!-- Authorization:30042 -->
        <FrontendPort>30042</FrontendPort>
        <BackendPort>30042</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- Events:30011 -->
        <FrontendPort>30011</FrontendPort>
        <BackendPort>30011</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- SqlServerRP:30010 -->
        <FrontendPort>30010</FrontendPort>
        <BackendPort>30010</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- Subscriptions:30040 -->
        <FrontendPort>30040</FrontendPort>
        <BackendPort>30040</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- Usage:30022 -->
        <FrontendPort>30022</FrontendPort>
        <BackendPort>30022</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- WindowsAuthSite:12998 -->
        <FrontendPort>12998</FrontendPort>
        <BackendPort>12998</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- ResourceManagerAdmin:30050 -->
        <FrontendPort>30050</FrontendPort>
        <BackendPort>30050</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
    </Parameters>
  </Task> <!-- AddLoadBalancer_WAPInternal[32] Authorization:30042 Events:30011 SqlServerRP:30010 Subscriptions:30040 Usage:30022 WindowsAuthSite:12998 ResourceManagerAdmin:30050-->
  <!-- External Vip -->
  <Task> 
    <Name>AddLoadBalancer_xRPExternal</Name>
    <Cmd>AddLoadBalancer.ps1</Cmd>
    <Dependency>SetupMux</Dependency>
    <Dependency>AddVMtoNC_xRPVM</Dependency>
    <Weight>8</Weight>
    <Timeout>300</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <NCName>{[NCVM]:Name}</NCName>
      <FQDN>{[Global]:ADDomainName}</FQDN>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>     
      <VIPLogicalNetworkResourceId>{[Global]:ResourceIDs.VIPLogicalNetworkResourceId}</VIPLogicalNetworkResourceId>
      <Vip>192.168.133.71</Vip>
      <Rule> <!-- SRPExtension:12646 -->
        <FrontendPort>12646</FrontendPort>
        <BackendPort>12646</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- NRPExtension:12647 -->
        <FrontendPort>12647</FrontendPort>
        <BackendPort>12647</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- CRPExtension:12648 -->
        <FrontendPort>12648</FrontendPort>
        <BackendPort>12648</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- TenantExtension:12649 -->
        <FrontendPort>12649</FrontendPort>
        <BackendPort>12649</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_xRPVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
    </Parameters>
  </Task> <!-- AddLoadBalancer_xRPExternal[71] SRPExtension:12646 NRPExtension:12647 CRPExtension:12648 TenantExtension:12649-->
  <Task>
    <Name>AddLoadBalancer_ACS</Name>
    <Cmd>AddLoadBalancer.ps1</Cmd>
    <Dependency>SetupMux</Dependency>
    <Dependency>AddVMtoNC_ACSVM</Dependency>
    <Weight>4</Weight>
    <Timeout>300</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <NCName>{[NCVM]:Name}</NCName>
      <FQDN>{[Global]:ADDomainName}</FQDN>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>     
      <VIPLogicalNetworkResourceId>{[Global]:ResourceIDs.VIPLogicalNetworkResourceId}</VIPLogicalNetworkResourceId>
      <Vip>192.168.133.72</Vip>
      <Rule> <!-- Http:80 -->
        <FrontendPort>80</FrontendPort>
        <BackendPort>80</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_ACSVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- Https:443 -->
        <FrontendPort>443</FrontendPort>
        <BackendPort>443</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_ACSVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
    </Parameters>
  </Task> <!-- AddLoadBalancer_ACS[72] Http:80 Https:443-->
  <Task>
    <Name>AddLoadBalancer_WAPExternal</Name>
    <Cmd>AddLoadBalancer.ps1</Cmd>
    <Dependency>SetupMux</Dependency>
    <Dependency>AddVMtoNC_PortalVM</Dependency>
    <Weight>18</Weight>
    <Timeout>300</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <NCName>{[NCVM]:Name}</NCName>
      <FQDN>{[Global]:ADDomainName}</FQDN>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>     
      <VIPLogicalNetworkResourceId>{[Global]:ResourceIDs.VIPLogicalNetworkResourceId}</VIPLogicalNetworkResourceId>
      <Vip>192.168.133.74</Vip>
      <Rule> <!-- ShellSite/Resource Manager:443 to 443 -->
        <FrontendPort>443</FrontendPort>
        <BackendPort>443</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- BillingExtension:13011 -->
        <FrontendPort>13011</FrontendPort>
        <BackendPort>13011</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- HubsExtension:13001 -->
        <FrontendPort>13001</FrontendPort>
        <BackendPort>13001</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- InsightsTenantExtension:13010 -->
        <FrontendPort>13010</FrontendPort>
        <BackendPort>13010</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- RbacExtension:13020 -->
        <FrontendPort>13020</FrontendPort>
        <BackendPort>13020</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- SqlAdminExtension:13002 -->
        <FrontendPort>13002</FrontendPort>
        <BackendPort>13002</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- SqlTenantExtension:13005 -->
        <FrontendPort>13005</FrontendPort>
        <BackendPort>13005</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- SubscriptionsTenantExtension:13003 -->
        <FrontendPort>13003</FrontendPort>
        <BackendPort>13003</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
      <Rule> <!-- Monitoring:30052 -->
        <FrontendPort>30052</FrontendPort>
        <BackendPort>30052</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
    </Parameters>
  </Task> <!-- AddLoadBalancer_WAPExternal[74] ShellSite/Resource Manager: 443 to 443 BillingExtension:13011 HubsExtension:13001 InsightsTenantExtension:13010 RbacExtension:13020 SqlAdminExtension:13002 SqlTenantExtension:13005 SubscriptionsTenantExtension:13003 Monitoring:30052 -->
 <Task>
    <Name>AddLoadBalancer_WAPGallery</Name>
    <Cmd>AddLoadBalancer.ps1</Cmd>
    <Dependency>SetupMux</Dependency>
    <Dependency>AddVMtoNC_PortalVM</Dependency>
    <Weight>2</Weight>
    <Timeout>300</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <NCName>{[NCVM]:Name}</NCName>
      <FQDN>{[Global]:ADDomainName}</FQDN>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>     
      <VIPLogicalNetworkResourceId>{[Global]:ResourceIDs.VIPLogicalNetworkResourceId}</VIPLogicalNetworkResourceId>
      <Vip>192.168.133.75</Vip>
      <Rule> <!-- Gallery:30016 to 30016-->
        <FrontendPort>30016</FrontendPort>
        <BackendPort>30016</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
    </Parameters>
  </Task> <!-- AddLoadBalancer_WAPGallery[75] Gallery:30016 to 30016-->  
  <!-- TODO Test Vip, will be deleted -->
  <Task>
    <Name>AddLoadBalancer_ACSVMTS</Name>
    <Cmd>AddLoadBalancer.ps1</Cmd>
    <Dependency>SetupMux</Dependency>
    <Dependency>AddVMtoNC_ACSVM</Dependency>
    <Weight>2</Weight>
    <Timeout>300</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <NCName>{[NCVM]:Name}</NCName>
      <FQDN>{[Global]:ADDomainName}</FQDN>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>     
      <VIPLogicalNetworkResourceId>{[Global]:ResourceIDs.VIPLogicalNetworkResourceId}</VIPLogicalNetworkResourceId>
      <Vip>192.168.133.91</Vip>
      <Rule> <!-- TS:3389 -->
        <FrontendPort>3389</FrontendPort>
        <BackendPort>3389</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_ACSVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
    </Parameters>
  </Task> <!-- AddLoadBalancer_ACSVMTS [91] TS:3389-->
  <Task> 
    <Name>AddLoadBalancer_PortalVMTest</Name>
    <Cmd>AddLoadBalancer.ps1</Cmd>
    <Dependency>SetupMux</Dependency>
    <Dependency>AddVMtoNC_PortalVM</Dependency>
    <Weight>4</Weight>
    <Timeout>300</Timeout>
    <Retry>1</Retry>
    <Parameters>
      <NCName>{[NCVM]:Name}</NCName>
      <FQDN>{[Global]:ADDomainName}</FQDN>
      <DomainAdminPassword>{[ADVM]:LocalAccounts.AdministratorPassword}</DomainAdminPassword>     
      <VIPLogicalNetworkResourceId>{[Global]:ResourceIDs.VIPLogicalNetworkResourceId}</VIPLogicalNetworkResourceId>
      <Vip>192.168.133.92</Vip>
      <Rule> <!-- Http:80 -->
        <FrontendPort>80</FrontendPort>
        <BackendPort>80</BackendPort>
        <DipNetworkInterfaceResourceId>{[AddVMtoNC_PortalVM]:PortProfileId}</DipNetworkInterfaceResourceId>
        <InboundProtocol>TCP</InboundProtocol>
      </Rule>
    </Parameters>
  </Task> <!-- AddLoadBalancer_PortalVMTest [92] Http:80 -->
  <Sample>
    <Name>Sample</Name>
    <Cmd>Sample.ps1</Cmd>
    <Dependency>otherSample1</Dependency> <!-- Optional -->
    <Dependency>otherSample2</Dependency>
    <Retry>2</Retry>
    <Timeout>60</Timeout> <!-- Optional. In sec, 0 means timeout immediately-->
    <CleanupCmd>Sample_Clean.ps1</CleanupCmd> <!-- Optional -->
    <Weight>1</Weight> <!-- For process bar -->
    <Parameters>
      <P1>XXX</P1>
      <P2>{[Sample]:P1}</P2> <!-- ref -->
    </Parameters>
    <!-- Run Time Status, set by engine -->
    <Status>NotStarted</Status> <!-- NotStarted, Running, Pass, Fail, Cleaning -->
    <PendingReboot>0</PendingReboot>
    <Runs>0</Runs>
    <Job></Job>
    <Instance>aa819a5a-d9b3-4afb-a761-3fa9eb4176af</Instance>
    <StartTime-aa819a5a-d9b3-4afb-a761-3fa9eb4176af></StartTime-aa819a5a-d9b3-4afb-a761-3fa9eb4176af>
    <EndTime-aa819a5a-d9b3-4afb-a761-3fa9eb4176af></EndTime-aa819a5a-d9b3-4afb-a761-3fa9eb4176af>
  </Sample>
  <Global>
    <DeploymentID>00000000-0000-0000-0000-000000000000</DeploymentID>
    <Interval>20</Interval> <!-- In sec -->
    <Status>NotStarted</Status>
    <Log>C:\CloudConsistency\Log</Log>
    <PackagePath>C:\CloudConsistency\VHDs</PackagePath>
    <AzureStackPath>C:\CloudConsistency</AzureStackPath>
    <ADDomainName>Poc.local</ADDomainName>
    <ADNetBiosName>Poc</ADNetBiosName>
    <AdminPassword SecureString="PlainText">User@123</AdminPassword>
    <ProcessName>PoCFabricSetup</ProcessName>
    <InternalNetworkVLan>1001</InternalNetworkVLan>
    <ExternalNetworkVLan>1002</ExternalNetworkVLan>
    <PublicVLan></PublicVLan>
    <InternalDNS>192.168.100.2</InternalDNS>
    <InternalGW>192.168.100.1</InternalGW>
    <NATVMPublicIPFromDHCP>true</NATVMPublicIPFromDHCP>
    <NATVMStaticIP>0.0.0.0/24</NATVMStaticIP>
    <NATVMStaticGateway>0.0.0.0</NATVMStaticGateway>
    <ProxyServer>0.0.0.0:80</ProxyServer>
    <VHDs>
      <PoCVHD>MicrosoftAzureStackPOC.vhdx</PoCVHD>
      <SQLVHD>SQLServer2014.vhdx</SQLVHD>
      <OSVHD>WindowsServer2016Datacenter.vhdx</OSVHD>
      <GalleryVHD>WindowsServer2012R2DatacenterEval.vhd</GalleryVHD>
    </VHDs>
    <ResourceIDs>
      <NCCredentialResourceId>c6abefb6-24ab-45f6-80ec-5ebd690a544f</NCCredentialResourceId>
      <HostCredentialResourceId>b6a1d5d6-5e1a-4f63-982d-c3da2ad54ee2</HostCredentialResourceId>
      <PALogicalNetworkResourceId>bb6c6f28-bad9-441b-8e62-57d2be255904</PALogicalNetworkResourceId>
      <TransitLogicalNetworkResourceId>d7bf84e9-bf5c-48c7-896a-1a068915d0f4</TransitLogicalNetworkResourceId>
      <VIPLogicalNetworkResourceId>f8f67956-3906-4303-94c5-09cf91e7e311</VIPLogicalNetworkResourceId>
      <MACAddressPoolResourceId>8197fd09-8a69-417e-a55c-10c2c61f5ee7</MACAddressPoolResourceId>
      <MuxVirtualServerResourceId>d2b75161-ec7d-4141-8653-39ab194a2291</MuxVirtualServerResourceId>
      <MuxResourceId>86c0a59c-4ffe-4b12-847c-641291fb465c</MuxResourceId>
      <AclResourceId>e3f80534-68c8-4656-a6f4-d6dff2202f74</AclResourceId>
    </ResourceIDs>
  </Global>
</Settings>
